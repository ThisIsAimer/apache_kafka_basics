services:
  kafka:
    image: apache/kafka:4.0.0 # Apache Kafka 4.0.0 Docker image
    hostname: kafka
    container_name: kafka-broker

    ports:
      - "9092:9092" # External listener for clients
      - "9093:9093" # Internal listener for KRaft controller communication

    environment:
      # # --- KRaft Configuration for Apache Kafka 4.0 ---
      KAFKA_PROCESS_ROLES: 'broker,controller' # is the default for a combined node in Kafka 4.0's entrypoint.
      KAFKA_NODE_ID: 1 # is often enough, but let's be explicit with the broker ID.
      KAFKA_BROKER_ID: 1 # Use KAFKA_BROKER_ID for Apache image

      # # Crucial: The Cluster ID must be passed to the running Kafka process
      CLUSTER_ID: 'sqynJkB6QPC-tFX8c_15QQ' # <--- USE YOUR ACTUAL CLUSTER ID HERE!

      # # KRaft specific configuration, defining the controller quorum
      # # Format: <node id>@<hostname>:<controller_port>
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:9093'

      # # Listeners configuration
      # # The Apache image often has more specific defaults, but being explicit is good.
      # Listeners define what Kafka binds to INSIDE the container
      KAFKA_LISTENERS: CLIENT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      # Advertised listeners tell clients (and other brokers) how to connect
      # CLIENT listener: For external Go apps on your host
      # CONTROLLER listener: For internal KRaft quorum communication (self-referential for single node)
      KAFKA_ADVERTISED_LISTENERS: CLIENT://localhost:9092,CONTROLLER://kafka:9093 # Note: 'kafka' for internal controller communication
      # This maps our custom listener names (CLIENT, CONTROLLER) to their security protocols (PLAINTEXT)
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CLIENT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      # This explicitly tells Kafka which listener to use for inter-broker communication
      KAFKA_INTER_BROKER_LISTENER_NAME: CLIENT

      # # Paths for logs and KRaft metadata.
      # # The default in the Apache image is often /var/lib/kafka/data.
      # # We'll stick to a common /tmp path for simplicity in Docker.
      KAFKA_LOG_DIRS: '/tmp/kraft-data' # Where Kafka stores its log data and KRaft metadata # Explicitly set log directory for consistency with volume mount

      ### FROM APACHE KAFKA DOCKER HUB NOTES
      # --- Other Standard Kafka Configurations ---
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1 # For single broker, replication factor must be 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1      
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_NUM_PARTITIONS: 3 # Default for new topics

    # If you want to persist Kafka data between Docker restarts, create a named volume and map it.
    # We will explicitly mount our data volume here.
    volumes:
      - ./kafka-data:/tmp/kraft-data # Map host folder to container data path

# Define a bridge network for containers to communicate
networks:
  kafka-net:
    driver: bridge

# Define the local volume for persistent data explicitly for clarity and management
volumes:
  kafka-data:
    driver: local